## 20 Квотирование диска

!!! abstract ""
    [Для Linux](#201-настройка-в-linux) | [Для FreeBSD](#202-настройка-в-freebsd) | [Управление лимитами](#203-назначение-лимитов-квоты)

Квотирование диска позволяет ограничить объем дискового пространства и/или количество файлов, которые может использовать пользователь или (или член группы). Квоты выделяются на основе файловой системы и регулируются ядром.

### 20.1 Настройка в Linux

Обычно необходимо установить пакет инструментов квотирования, который содержит инструменты командной строки.  
Активируйте пользовательскую квоту в файле **fstab** и перезагрузите раздел. Если раздел занят, то необходимо закрыть все заблокированные файлы или перезагрузить систему. Добавьте usrquota в параметры монтирования в файле **fstab**, например:

!!! example ""
    */dev/sda2     /home    reiserfs     rw,acl,user_xattr,usrquota 1 1*  
    **# mount -o remount /home**  
    **# mount**                              - Проверьте, активирована ли usrquota, в противном случае перезагрузите систему  

Инициализируйте файл `quota.user` с помощью команды `quotacheck`.

!!! example ""
    **# quotacheck -vum /home**  
    **# chmod 644 /home/aquota.user**        - Чтобы пользователи могли проверять свою собственную квоту  

Активируйте квоту с помощью предоставленного скрипта (например, /etc/init.d/quotad в SuSE) или с помощью команды `quotaon`:

!!! example ""
    **quotaon -vu /home**

Проверьте, что квота активирована:

!!! example ""
    **quota -v**

### 20.2 Настройка в FreeBSD

Инструменты квотирования входят в базовую систему, однако для ядра требуется опция `quota`. Если ее нет, добавьте и перекомпилируйте ядро.

!!! example ""
    **options QUOTA**

Как и в Linux, добавьте опцию квотирования в параметры `fstab` (`userquota`, а не `usrquota`):

!!! example ""
    */dev/ad0s1d    /home    ufs     rw,noatime,userquota    2  2*  
    **# mount /home**                        - Перемонтируйте раздел  

Включите квоты диска в `/etc/rc.conf` и запустите квотирование.

!!! example ""
    **# grep quotas /etc/rc.conf**  
    *enable_quotas="YES"*                   включить квоты при запуске (или NO).  
    *check_quotas="YES"*                    Проверять квоты при запуске (или NO).  
    **# /etc/rc.d/quota start**  

### 20.3 Назначение лимитов квоты

По умолчанию квоты не ограничены (установлены в 0). Лимиты устанавливаются с помощью команды `edquota` для отдельных пользователей. Квота может также дублироваться для нескольких пользователей. Структура файла отличается между реализациями квотирования, но принцип остаётся тем же: значения блоков и инодов могут быть ограничены. Изменяются только значения `soft` и `hard`. Если они не указаны, то блоки равны 1Кб. Срок действия отсрочки устанавливается с помощью команды `edquota -t`. Например:

!!! example ""
    **# edquota -u colin**

#### Linux

!!! info "Квотирование диска для пользователя colin (uid 1007):"
    *Filesystem         blocks       soft       hard     inodes     soft     hard*  
    */dev/sda8              108       1000       2000         1        0        0*  

#### FreeBSD

!!! info "Квоты для пользователя colin:"
    */home: kbytes in use: 504184, limits (soft = 700000, hard = 800000)*  
       *inodes in use: 1792, limits (soft = 0, hard = 0)*  

#### Для многих пользователей

Команда `edquota -p` используется для дублирования квоты для других пользователей. Например, чтобы дублировать исходную квоту для всех пользователей:

!!! example ""
    **# edquota -p <исходный_пользователь> `awk -F: '$3 &gt; 499 {print $1}' /etc/passwd`**  
    **# edquota -p <исходный_пользователь> <пользователь1> <пользователь2>**     - Дублирование для 2 пользователей  

#### Проверка

Пользователи могут проверить свою квоту, просто набрав quota (файл `quota.user` должен быть доступен для чтения). Администратор может проверить все квоты.

!!! example ""
    **# quota -u <имя_пользователя>**                     - Проверить квоту для пользователя  
    **# repquota /home**                                  - Полный отчет по разделу для всех пользователей  
