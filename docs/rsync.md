## 7 RSYNC

!!! abstract ""
    [Rsync в Linux](#71-rsync-в-linux) | [Rsync в Windows](#72-rsync-в-windows)

Rsync практически полностью заменяет cp и scp, кроме того, прерванные передачи эффективно возобновляются. Завершающая косая черта (и ее отсутствие) имеет различные значения, хорошо описанные в man-странице... Вот некоторые примеры:

### 7.1 Rsync в Linux

Копирование каталогов со всем содержимым:

!!! example ""
    **# rsync -a /home/colin/ /backup/colin/**                - режим "архив" - сохранение одинаковой структуры  
    **# rsync -a /var/ /var_bak/**  
    **# rsync -aR --delete-during /home/user/ /backup/**      - использование относительных путей (см. ниже)  
    **# /opt/local/bin/rsync -azv --iconv=UTF-8-MAC,UTF-8 ~/Music/flac/ me@server:/dst/**   - преобразует имена файлов из UTF-8 для ОС X в UTF-8 для Windows  

То же самое, но через сеть и с сжатием. Rsync по умолчанию использует SSH в качестве транспорта и будет использовать ключ SSH, если они заданы. Пример удаленного копирования:

!!! example ""
    **# rsync -axSRzv /home/user/ user@server:/backup/user/** - Копирование на удаленный сервер  
    **# rsync -a 'user@server:My\ Documents' My\ Documents**  - Экранирование пробелов для удаленного shell  

Исключить любой каталог `tmp` внутри `/home/user/` и сохранить относительные пути. Иерархия каталогов, то есть удаленный каталог будет иметь структуру `/backup/home/user/`. Это обычно используется для резервных копий.

!!! example ""
    **# rsync -azR --exclude=tmp/ /home/user/ user@server:/backup/**

Используйте порт 20022 для соединения ssh:

!!! example ""
    **# rsync -az -e 'ssh -p 20022' /home/colin/ user@server:/backup/colin/**

Использование демона `rsync` (используется с "::") намного быстрее, но не зашифровано через ssh. Расположение /backup определяется конфигурацией в `/etc/rsyncd.conf`. Переменная `RSYNC_PASSWORD` может быть установлена, чтобы избежать необходимости вручную вводить пароль.

!!! example ""
    **# rsync -axSRz /home/ ruser@hostname::rmodule/backup/**  
    **# rsync -axSRz ruser@hostname::rmodule/backup/ /home/** - Копировать обратно  

!!! info "Некоторые важные параметры:"
    | Опции                 | Описание                                           |
    | :-------------------- | :------------------------------------------------- |
    | -a, --archive         | архивный режим; то же, что и `-rlptgoD `(без `-H`) |
    | -r, --recursive       | рекурсия в каталоги                                |
    | -R, --relative        | использовать относительные имена путей             |
    | -H, --hard-links      | сохранять жесткие ссылки                           |
    | -S, --sparse          | эффективно обрабатывать разреженные файлы          |
    | -x, --one-file-system | не пересекать границы файловых систем              |
    | --exclude=PATTERN     | исключить файлы, соответствующие ШАБЛОНУ           |
    | --delete-during       | получатель удаляет во время передачи               |
    | --delete-after        | получатель удаляет после передачи                  |

### 7.2 Rsync в Windows

Rsync доступен для Windows через `cygwin` или как отдельный пакет в [cwrsync](http://sourceforge.net/projects/sereds). Это очень удобно для автоматизированных резервных копий. Установите один из них (не оба) и добавьте путь к переменным среды Windows: `Панель управления -> Система -> вкладка Дополнительно`, кнопка Переменные среды. Измените системную переменную "Путь" и добавьте полный путь к установленному `rsync`, например `C:\Program Files\cwRsync\bin` или `C:\cygwin\bin`. Таким образом команды `rsync` и `ssh` будут доступны в командной строке Windows.  

#### Аутентификация по открытому ключу

Rsync автоматически туннелируется через SSH и таким образом использует аутентификацию SSH на сервере. Автоматические резервные копии должны избегать взаимодействия с пользователем, для этого может быть использована аутентификация по открытому ключу SSH, и команда `rsync` будет выполняться без пароля.

Все следующие команды выполняются в консоли Windows. В консоли (Пуск -> Выполнить -> cmd) создайте и загрузите ключ, как описано в SSH, изменив "user" и "server" соответствующим образом. Если файла `authorized_keys2` еще не существует, просто скопируйте `id_dsa.pub` в `authorized_keys2` и загрузите его.

!!! example ""
    **# ssh-keygen -t dsa -N ''**                   - Создает открытый и закрытый ключ  
    **# rsync user@server:.ssh/authorized_keys2 .** - Копирует файл локально с сервера  
    **# cat id_dsa.pub >> authorized_keys2**        - Или используйте редактор, чтобы добавить ключ  
    **# rsync authorized_keys2 user@server:.ssh/**  - Копирует файл обратно на сервер  
    **# del authorized_keys2**                      - Удаляет локальную копию  

Теперь протестируйте это с (в одну строку):

!!! example ""
    **rsync -rv "/cygdrive/c/Documents and Settings/%USERNAME%/My Documents/" \\**  
    **'user@server:My\\ Documents/'**  

#### Автоматическое резервное копирование

Используйте пакетный файл для автоматизации резервного копирования и добавьте файл в запланированные задачи (Программы -> Стандартные -> Служебные -> Запланированные задачи). Например, создайте файл backup.bat и замените user@server.

!!! example ""
    ```dos
    @ECHO OFF
    REM резервное копирование каталога Мои документы  
    SETLOCAL
    SET CWRSYNCHOME=C:\\PROGRAM FILES\\CWRSYNC
    SET CYGWIN=nontsec 
    SET CWOLDPATH=%PATH%
    REM раскомментируйте следующую строку при использовании cygwin
    SET PATH=%CWRSYNCHOME%\\BIN;%PATH% 
    echo Нажмите Control-C для отмены
    rsync -av "/cygdrive/c/Documents and Settings/%USERNAME%/My Documents/" \\
    'user@server:My\\ Documents/'
    pause
    ```
