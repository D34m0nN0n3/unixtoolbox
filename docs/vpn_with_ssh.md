## 6 VPN с использованием SSH

!!! abstract ""
    [Одиночное P2P-соединение](#61-одиночное-p2p-соединение) | [Соединение двух сетей](#62-соединение-двух-сетей)

Начиная с версии 4.3, OpenSSH может использовать устройство `tun/tap` для шифрования туннеля. Это очень похоже на другие решения VPN на основе TLS, такие как OpenVPN. Одним из преимуществ SSH является то, что нет необходимости устанавливать и настраивать дополнительное программное обеспечение. Кроме того, туннель использует аутентификацию SSH, такую как предварительно распределенные ключи. Недостатком является то, что инкапсуляция выполняется через TCP, что может привести к плохой производительности при медленном соединении. Кроме того, туннель полагается на одно (хрупкое) TCP-соединение. Эта техника очень полезна для быстрой настройки IP-основанной VPN. В отличие от одиночного TCP-перенаправления здесь нет ограничений, все протоколы уровней 3 и 4, такие как ICMP, TCP/UDP и т. д., перенаправляются через VPN.

В любом случае, в файле `sshd_conf` нужно указать следующие параметры:

!!! note ""
    *PermitRootLogin yes*  
    *PermitTunnel yes*  

### 6.1 Одиночное P2P-соединение

Здесь мы соединяем два хоста, `hclient` и `hserver`, с помощью туннеля `peer to peer`. Соединение начинается с `hclient` к `hserver` и осуществляется от имени `root`. Конечные точки туннеля - 10.0.1.1 (сервер) и 10.0.1.2 (клиент), а также мы создаем устройство `tun5` (это может быть и другое число). Процедура очень простая:

* Подключитесь с помощью SSH с опцией туннеля -w.
* Настройте IP-адреса туннеля. Один раз на сервере и один раз на клиенте.

#### Подключитесь к серверу

Соединение начинается на клиенте, команды выполняются на сервере.

!!! example "Сервер работает на Linux"
    *client->* **# ssh -w5:5 root@hserver**  
    *server->* **# ifconfig tun5 10.0.1.1 netmask 255.255.255.252**   - Выполняется в оболочке сервера  

!!! example "Сервер работает на FreeBSD"
    *client->* **# ssh -w5:5 root@hserver**  
    *server->* **# ifconfig tun5 10.0.1.1 10.0.1.2**                  - Выполняется в оболочке сервера  

#### Настройте клиент

!!! example "Выполните следующие команды на клиенте:"
    *client->* **# ifconfig tun5 10.0.1.2 netmask 255.255.255.252**   - Клиент работает на Linux  
    *client->* **# ifconfig tun5 10.0.1.2 10.0.1.1**                  - Клиент работает на FreeBSD  

Теперь два хоста соединены и могут прозрачно обмениваться данными с использованием IP-адресов туннеля на уровне протоколов 3 и 4.

### 6.2 Соединение двух сетей

В дополнение к установке p2p выше, более полезно соединить две частные сети с помощью SSH VPN, используя два шлюза. Предположим, например, что netA - это 192.168.51.0/24, а netB - 192.168.16.0/24. Процедура аналогична предыдущей, но мы также должны добавить маршрутизацию. NAT должен быть активирован только на частном интерфейсе, если шлюзы не являются теми же самыми как шлюз по умолчанию для их сети.
192.168.51.0/24 (netA)|gateA &lt;-&gt; gateB|192.168.16.0/24 (netB)

* Подключитесь с помощью SSH с опцией туннеля `-w`.
* Настройте IP-адреса туннеля. Один раз на сервере и один раз на клиенте.
* Добавьте маршрутизацию для двух сетей.
* При необходимости активируйте NAT на частном интерфейсе шлюза.

*Установка начинается с gateA в netA.*

#### Подключитесь от gateA к gateB

Соединение начинается с gateA, команды выполняются на gateB.

!!! example "gateB работает на Linux"
    *gateA->* **# ssh -w5:5 root@gateB**  
    *gateB->* **# ifconfig tun5 10.0.1.1 netmask 255.255.255.252**              - Выполняется в оболочке gateB  
    *gateB->* **# route add -net 192.168.51.0 netmask 255.255.255.0 dev tun5**  
    *gateB->* **# echo 1 &gt; /proc/sys/net/ipv4/ip_forward**                   - Только если не является шлюзом по умолчанию  
    *gateB->* **# iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE**  

!!! example "gateB находится на FreeBSD"
    *gateA->* **# ssh -w5:5 root@gateB**                          - Создает устройства tun5  
    *gateB->* **# ifconfig tun5 10.0.1.1 10.0.1.2**               - Выполняется в оболочке gateB  
    *gateB->* **# route add 192.168.51.0/24 10.0.1.2**  
    *gateB->* **# sysctl net.inet.ip.forwarding=1**               - Необходимо только если не является шлюзом по умолчанию  
    *gateB->* **# natd -s -m -u -dynamic -n fxp0**                - см. NAT  
    *gateA->* **# sysctl net.inet.ip.fw.enable=1**  

#### Настроить gateA

Команды, выполняемые на gateA:

!!! example "gateA находится на Linux"
    *gateA->* **# ifconfig tun5 10.0.1.2 netmask 255.255.255.252**  
    *gateA->* **# route add -net 192.168.16.0 netmask 255.255.255.0 dev tun5**  
    *gateA->* **# echo 1 &gt; /proc/sys/net/ipv4/ip_forward**  
    *gateA->* **# iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE**  

!!! example "gateA находится на FreeBSD"
    *gateA->* **# ifconfig tun5 10.0.1.2 10.0.1.1**  
    *gateA->* **# route add 192.168.16.0/24 10.0.1.2**  
    *gateA->* **# sysctl net.inet.ip.forwarding=1**  
    *gateA->* **# natd -s -m -u -dynamic -n fxp0**                - см. NAT  
    *gateA->* **# sysctl net.inet.ip.fw.enable=1**  

Два частных сети теперь прозрачно соединены через SSH VPN. Настройки пересылки IP и NAT необходимы только если шлюзы не являются шлюзами по умолчанию. В этом случае клиенты не будут знать, куда направить ответ, и необходимо активировать NAT.
