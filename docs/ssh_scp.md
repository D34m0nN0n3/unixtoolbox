## 5 SSH SCP

!!! abstract ""
    [Открытый ключ](#51-аутентификация-с-открытым-ключом) | [Отпечаток](#52-проверка-отпечатка) | [SCP](#53-безопасная-передача-файлов) | [Туннелирование](#54-туннелирование)

Смотрите другие приемы 25 ssh [cmd](http://blog.urfix.com/25-ssh-commands-tricks/)

### 5.1 Аутентификация с открытым ключом

Подключайтесь к хосту без пароля, используя аутентификацию с открытым ключом. Идея заключается в том, чтобы добавить свой открытый ключ в файл `authorized_keys2` на удаленном хосте. В этом примере давайте подключим клиентской хост к серверу-хосту, ключ генерируется на клиенте. Если вы используете `cygwin`, вам может потребоваться создать домашний каталог и каталог `.ssh` командой `# mkdir -p /home/USER/.ssh`

* Используйте ssh-keygen для генерации ключевой пары. `~/.ssh/id_dsa` - это закрытый ключ, `~/.ssh/id_dsa.pub` - это открытый ключ.
* Скопируйте только открытый ключ на сервер и добавьте его в файл `~/.ssh/authorized_keys2` в вашем домашнем каталоге на сервере.

!!! example ""
    **# ssh-keygen -t dsa -N ''**  
    **# cat ~/.ssh/id_dsa.pub | ssh you@host-server "cat - >> ~/.ssh/authorized_keys2"**  

#### Использование клиента Windows от ssh.com

Некоммерческая версия клиента ssh.com может быть загружена с основного [FTP-сайта](ftp.ssh.com/pub/ssh/).
Ключи, сгенерированные клиентом ssh.com, требуют преобразования для OpenSSH сервера. Это можно сделать с помощью команды `ssh-keygen`.

* Создайте пару ключей с клиентом ssh.com: Настройки - Пользовательская аутентификация - Создать новую....
* Я использую тип ключа DSA; длина ключа 2048.
* Скопируйте открытый ключ, сгенерированный клиентом ssh.com, на сервер в папку `~/.ssh`.
* Ключи находятся в папке `C:\Documents` and `Settings\%USERNAME%\Application Data\SSH\UserKeys`.
* Используйте команду `ssh-keygen` на сервере для конвертации ключа:

!!! example ""
    **# cd ~/.ssh**  
    **# ssh-keygen -i -f keyfilename.pub >> authorized_keys2**  

!!! info "Примечание:"
    Мы использовали DSA-ключ, также возможно использование RSA. Ключ не защищен паролем.

#### Использование Putty для Windows

[Putty](http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html) - это простой и бесплатный SSH-клиент для Windows.

* Создайте пару ключей с помощью программы `PuTTYgen`.
* Сохраните открытый и закрытый ключи (например, в папке `C:\Documents and Settings\%USERNAME%\.ssh`).
* Скопируйте открытый ключ на сервер в папку `~/.ssh`:
  
!!! example ""
    **# scp .ssh/puttykey.pub root@192.168.51.254:.ssh/**

* Используйте команду `ssh-keygen` на сервере для конвертации ключа для OpenSSH:

!!! example ""
    **# cd ~/.ssh**  
    **# ssh-keygen -i -f puttykey.pub >> authorized_keys2**  

* Укажите расположение закрытого ключа в настройках PuTTY: *`Connection -> SSH -> Auth`*

### 5.2 Проверка отпечатка

При первом входе SSH спросит, должен ли неизвестный хост с данным отпечатком быть сохранен в известных хостах. Чтобы избежать атаки "человек-посередине", администратор сервера может отправить вам отпечаток сервера, который затем будет сравниваться при первом входе. Используйте `ssh-keygen -l` для получения отпечатка (на сервере):

!!! example ""
    **# ssh-keygen -l -f /etc/ssh/ssh_host_rsa_key.pub**      - Для RSA-ключа  
    *2048 61:33:be:9b:ae:6c:36:31:fd:83:98:b7:99:2d:9f:cd /etc/ssh/ssh_host_rsa_key.pub*  
    **# ssh-keygen -l -f /etc/ssh/ssh_host_dsa_key.pub**      - Для DSA-ключа (по умолчанию)  
    *2048 14:4a:aa:d9:73:25:46:6d:0a:48:35:c7:f4:16:d4:ee /etc/ssh/ssh_host_dsa_key.pub*  

Теперь клиент, подключающийся к этому серверу, может проверить, что он подключается к правильному серверу:

!!! example ""
    **# ssh linda**  
    *The authenticity of host 'linda (192.168.16.54)' can't be established.*  
    *DSA key fingerprint is 14:4a:aa:d9:73:25:46:6d:0a:48:35:c7:f4:16:d4:ee.*  
    *Are you sure you want to continue connecting (yes/no)? yes*  

### 5.3 Безопасная передача файлов

Некоторые простые команды:

!!! example ""
    **# scp file.txt host-two:/tmp**  
    **# scp joe@host-two:/www/*.html /www/tmp**  
    **# scp -r joe@host-two:/www /www/tmp**  

В Konqueror или Midnight Commander можно получить доступ к удаленной файловой системе с помощью адреса `fish://user@gate`. Однако реализация работает очень медленно.

Кроме того, можно примонтировать удаленную папку с помощью sshfs - клиента файловой системы, основанного на SCP. См. fuse [sshfs](http://fuse.sourceforge.net/sshfs.html).

!!! note ""
    ssh_exchange_identification: соединение закрыто удаленным хостом

С этой ошибкой попробуйте следующее на сервере:

!!! example ""
    **# echo 'SSHD: ALL' &gt;&gt; /etc/hosts.allow**  
    **# systemctl restart sshd**                      - Для Linux  
    **# /etc/init.d/sshd restart**                    - Для FreeBSD  

### 5.4 Туннелирование

Туннелирование SSH позволяет перенаправлять или реверсировать порт через SSH соединение, тем самым защищая трафик и получая доступ к портам, которые иначе быть заблокированным. Это работает только с TCP. Общая номенклатура для прямого и обратного (см. также пример ssh и NAT):

!!! example ""
    **# ssh -L localport:desthost:destport user@gate** - хост-приемник, как видно из ворот  
    **# ssh -R destport:desthost:localport user@gate** - перенаправляет ваш локальный порт в пункт назначения  
         *# desthost:localport глазами клиента, инициирующего туннель*  
    **# ssh -X user@gate** - Для принудительной пересылки X  

Это подключится к шлюзу и перенаправит локальный порт на хост `desthost:destport`. Обратите внимание, что `desthost` - это целевой хост, как его видит шлюз, поэтому если соединение устанавливается с шлюзом, то `desthost` является `localhost`. Возможно более одного перенаправления портов.

#### Прямое перенаправление на шлюзе

Допустим, мы хотим получить доступ к CVS (порт 2401) и http (порт 80), которые запущены на шлюзе. Это самый простой пример, поэтому desthost равно localhost, и мы используем локальный порт 8080 вместо 80, чтобы не требовать прав администратора. После открытия сеанса ssh оба сервиса доступны на локальных портах.

!!! example ""
    **# ssh -L 2401:localhost:2401 -L 8080:localhost:80 user@gate**

#### Перенаправляем Netbios и удаленный рабочий стол на второй сервер

Предположим, что за воротами находится Windows smb-сервер, который не использует ssh. Нам нужен доступ к smb-шаре, а также удаленному рабочему столу на сервере.

!!! example ""
    **# ssh -L 139:smbserver:139 -L 3388:smbserver:3389 user@gate**

Теперь можно получить доступ к smb-шаре по адресу `\\127.0.0.1\`, но только если локальный шар отключен, поскольку он слушает порт 139.

Возможно оставить локальный шар включенным, для этого нужно создать новое виртуальное устройство с новым IP-адресом для туннеля, smb-шара будет подключаться через этот адрес. Кроме того, локальный RDP уже слушает на порту 3389, поэтому мы выбираем порт 3388. Для этого примера давайте использовать виртуальный IP-адрес 10.1.1.1.

* С помощью Putty используйте исходный порт 10.1.1.1:139. Возможно создать несколько петлевых устройств и туннелей. На Windows 2000 только Putty работал для меня. В Windows Vista также перенаправьте порт 445 в дополнение к порту 139. Также на Vista патч `KB942624` предотвращает перенаправление порта 445, поэтому мне пришлось удалить этот патч на Vista.
* С использованием клиента ssh.com отключите "Разрешить только локальные подключения". Поскольку ssh.com будет привязан ко всем адресам, можно подключить только одну общую сеть.

Теперь создайте интерфейс обратной петли с IP-адресом 10.1.1.1:

* Система -> Панель управления -> Добавить оборудование # Да, оборудование уже подключено # Добавить новое оборудование (внизу).
* Установить оборудование, которое я выбираю самостоятельно # Сетевые адаптеры # Microsoft , Microsoft Loopback Adapter.
* Настройте IP-адрес фиктивного устройства на 10.1.1.1 маска 255.255.255.0, без шлюза.
* advanced -> WINS, Включить поиск LMHosts; Отключить NetBIOS через TCP/IP.
* Включить клиент для сетей Microsoft. # Отключить общий доступ к файлам и принтерам для сетей Microsoft.

Мне пришлось перезагрузиться, чтобы это сработало. Теперь подключитесь к smb-общему ресурсу с помощью `\\10.1.1.1` и удаленному рабочему столу по адресу `10.1.1.1:3388`.

##### Отладка

Если это не работает:

* Проброшены ли порты: `netstat -an`? Посмотрите на 0.0.0.0:139 или 10.1.1.1:139
* Подключается ли `telnet 10.1.1.1 139`?
* Вам нужна флажок "Локальные порты принимают подключения от других хостов".
* Отключен ли "Общий доступ к файлам и принтерам для сетей Microsoft" на интерфейсе обратной петли?

#### Подключение двух клиентов за маршрутизатором NAT

Предположим, что два клиента находятся за маршрутизатором NAT, и клиент cliadmin должен подключиться к клиенту cliuser (назначению), оба могут войти в систему на шлюз с помощью ssh и работают на Linux с sshd. Вам не нужны права root где-либо, если порты на шлюзе выше 1024. Мы используем порт 2022 на шлюзе. Также поскольку шлюз используется локально, опция GatewayPorts не является необходимой.

На клиенте cliuser (от назначения к шлюзу):

!!! example ""
    **# ssh -R 2022:localhost:22 user@gate**            - пересылает клиентский порт 22 на шлюз:2022

На клиенте cliadmin (от хоста к шлюзу):

!!! example ""
    **# ssh -L 3022:localhost:2022 admin@gate**         - пересылает клиентский порт 3022 на шлюз:2022

Теперь администратор может подключиться напрямую к клиенту cliuser с помощью команды:

!!! example ""
    **# ssh -p 3022 admin@localhost**                   - локальный:3022 -> шлюз:2022 -> клиент:22

#### Подключение к VNC за маршрутизатором NAT

Предположим, что у клиента Windows VNC слушает порт 5900 и к нему нужен доступ из-за маршрутизатора NAT.

!!! example "На клиенте cliwin к шлюзу:"
    **# ssh -R 15900:localhost:5900 user@gate**

!!! example "На клиенте cliadmin (от хоста к шлюзу):"
    **# ssh -L 5900:localhost:15900 admin@gate**

!!! example "Теперь администратор может подключиться напрямую к VNC-клиенту с помощью команды:"
    **# vncconnect -display :0 localhost**

#### Создание многорежимного ssh-туннеля

Предположим, что вы не можете напрямую подключиться к серверу по ssh, а только через несколько промежуточных хостов (например, из-за проблем с маршрутизацией).
Иногда все еще необходимо установить прямое соединение клиент-сервер, например, для копирования файлов с помощью scp или пересылки других портов, таких как smb или vnc. Один из способов сделать это - объединить туннели вместе, чтобы перенаправить порт на сервер через промежуточные узлы. Этот "порт-носитель" достигает своего конечного назначения только на последнем соединении с сервером.

Предположим, что мы хотим перенаправить порт ssh от клиента к серверу через два прыжка. После создания туннеля возможно подключение к серверу напрямую с клиента (а также добавление другого перенаправления порта).

##### Создание туннеля в одной оболочке:

!!! example "клиент -> хост1 -> хост2 -> сервер и создание туннеля 5678"
    *client->* **# ssh -L5678:localhost:5678 host1**        - 5678 - произвольный порт для туннеля  
    *host_1->* **# ssh -L5678:localhost:5678 host2**        - перенаправляем 5678 с хост1 на хост2  
    *host_2->* **# ssh -L5678:localhost:22 server**         - завершаем туннель на порту 22 на сервере  

##### Использование туннеля с другой оболочки:

!!! example "клиент -> сервер с использованием туннеля 5678"
    **# ssh -p 5678 localhost**                         - подключение напрямую от клиента к серверу  
    **# scp -P 5678 myfile localhost:/tmp/**            - или копирование файла напрямую с помощью туннеля  
    **# rsync -e 'ssh -p 5678' myfile localhost:/tmp/** - или синхронизация файла напрямую на сервер  

#### Сценарий автоматического подключения и поддержки соединения

Я использую различные варианты следующего скрипта, чтобы поддерживать возможность доступа к машине через обратный ssh-туннель. Соединение автоматически восстанавливается, если оно закрыто. Вы можете добавить несколько туннелей `-L` или `-R` в одной строке.

!!! example ""
    ```bash
    #!/bin/sh
    COMMAND="ssh -N -f -g -R 3022:localhost:22 colin@example.com"
    pgrep -f -x "$COMMAND" > /dev/null 2>&1 || $COMMAND
    exit 0
    ```

!!! example ""
    *1 \* \* \* \* colin /home/colin/port_forward.sh*     - запись в crontab (здесь каждый час)
