## 12 CVS

!!! abstract ""
    [Настройка сервера](#121-настройка-сервера) | [Тестирование CVS](#122-проверка) | [Туннелирование SSH](#123-туннелирование-ssh-для-cvs) | [Использование CVS](#124-команды-и-использование-cvs)

### 12.1 Настройка сервера

Инициализация CVS

Решите, где будет находиться основной репозиторий, и создайте корневой каталог cvs. Например `/usr/local/cvs` (как root):

!!! example ""
    **# mkdir -p /usr/local/cvs**  
    **# setenv CVSROOT /usr/local/cvs** - Установите CVSROOT в новое место (локально)  
    **# cvs init**                      - Создает все внутренние конфигурационные файлы CVS  
    **# cd /root**  
    **# cvs checkout CVSROOT**          - Получите конфигурационные файлы для изменения  
    **# cd CVSROOT**  

Редактировать конфигурацию

!!! example ""
    **# cvs commit config**  
    *cat >> writers*                - Создать файл writers (также можно readers)  
    *colin*  
    *^D*                            - Используйте ++ctrl+d++ чтобы выйти из редактирования  
    **# cvs add writers**           - Добавить файл writers в репозиторий  
    **# cvs edit checkoutlist**  
    *# cat >> checkoutlist*  
    *writers*  
    *^D*                            - Используйте ++ctrl+d++ чтобы выйти из редактирования  
    **# cvs commit**                - Зафиксировать все изменения конфигурации  

Добавьте файл readers, если хотите различать права чтения и записи Примечание:
Не редактируйте файлы напрямую в основном cvs, а получите файл, измените его и проверьте. Мы сделали это с файлом writers, чтобы определить права записи.
Существует три популярных способа получить доступ к CVS в этот момент. Первые два не требуют дополнительной конфигурации. Смотрите примеры на CVSROOT ниже о том, как их использовать:

* Прямой локальный доступ к файловой системе. Пользователю(ям) нужны достаточные разрешения на файлы, чтобы получить прямой доступ к CS и нет дополнительной аутентификации кроме входа в ОС. Однако это полезно только если репозиторий локальный.

* Удаленный доступ по SSH с протоколом ext. Любой пользователь с учетной записью ssh и правами чтения/записи на сервере CVS может получить прямой доступ к CVS через ext по SSH без дополнительного туннелирования. На сервере CVS не нужен запущенный процесс. Для работы используется аутентификация ssh. Удаленный доступ с pserver (порт по умолчанию: 2401/tcp). Это предпочтительный вариант для большого количества пользователей, так как пользователи аутентифицируются сервером pserver CVS со специальной базой паролей, поэтому необходимость в локальных учетных записях пользователей. Эта настройка объяснена ниже.

#### Настройка сети с использованием inetd
CVS может работать локально, только если нет необходимости в сетевом доступе. Для удаленного доступа демон inetd может запустить pserver с помощью следующей строки в файле /etc/inetd.conf (/etc/xinetd.d/cvs в SuSE):

!!! example ""
    **# cvspserver	stream  tcp  nowait  cvs  /usr/bin/cvs	cvs \\**
    **--allow-root=/usr/local/cvs pserver**

Желательно заблокировать порт cvs в Интернете с помощью брандмауэра и использовать ssh-туннель для удаленного доступа к репозиторию.

#### Отдельная аутентификация

Возможно иметь пользователей CVS, которые не являются частью ОС (без локальных пользователей). Это, с точки зрения безопасности, также, вероятно, желательно. Просто добавьте файл с именем passwd (в директории CVSROOT), содержащий логин и пароль пользователей в зашифрованном формате. Для этого можно использовать инструмент `htpasswd` в Apache.

!!! "Примечание"
    Файл passwd - единственный файл, который должен быть отредактирован напрямую в директории CVSROOT. Кроме того, он не будет выгружаться. Дополнительные сведения с помощью `htpasswd --help`.

!!! example ""
    **# htpasswd -cb passwd user1 password1** - `-c` создает файл  
    **# htpasswd -b passwd user2 password2**  

Теперь добавьте :cvs в конец каждой строки, чтобы указать серверу CVS изменить пользователя на cvs (или на то, под чем работает ваш сервер CVS). Это выглядит так:

!!! example ""
    **# cat passwd**  
    *user1:xsFjhU22u8Fuo:cvs*  
    *user2:vnefJOsnnvToM:cvs*  

### 12.2 Проверка

Проверьте вход в систему в качестве обычного пользователя Например:

!!! example ""
    **# cvs -d :pserver:colin@192.168.50.254:/usr/local/cvs login**  
    *Вход в систему: pserver:colin@192.168.50.254:2401/usr/local/cvs*  

Пароль CVS:

#### Переменная CVSROOT

Это переменная среды, используемая для указания расположения репозитория, над которым мы выполняем операции. Для локального использования она может быть просто установлена в каталог репозитория. Для использования по сети необходимо указать протокол передачи данных. Установите переменную CVSROOT с помощью setenv CVSROOT string в оболочке csh, tcsh или с помощью export `CVSROOT=string` в оболочке sh, bash.

!!! example ""
    **# setenv CVSROOT :pserver:\<username\>@\<host\>:/cvsdirectory**

!!! example "Например:"
    **# setenv CVSROOT /usr/local/cvs**                               - Только для локального использования  
    **# setenv CVSROOT :local:/usr/local/cvs**                        - То же, что и выше  
    **# setenv CVSROOT :ext:user@cvsserver:/usr/local/cvs**           - Прямой доступ с использованием SSH  
    **# setenv CVS_RSH ssh**                                          - для доступа по ext  
    **# setenv CVSROOT :pserver:user@cvsserver.254:/usr/local/cvs**   - сеть с использованием pserver  

Когда вход в систему успешен, можно импортировать новый проект в репозиторий:

!!! example "Перейдите в корневой каталог вашего проекта"
    **# cvs import \<module name=""\> \<vendor tag=""\> \<initial tag=""\>**  
    **# cvs -d :pserver:colin@192.168.50.254:/usr/local/cvs import MyProject MyCompany START**  


Где `MyProject` - имя нового проекта в репозитории (используется позже при его проверке). Cvs импортирует содержимое текущего каталога в новый проект.

Для проверки:

!!! example ""
    **# cvs -d :pserver:colin@192.168.50.254:/usr/local/cvs checkout MyProject**  
    *или*  
    **# setenv CVSROOT :pserver:colin@192.168.50.254:/usr/local/cvs**  
    **# cvs checkout MyProject**  

### 12.3 Туннелирование SSH для CVS

Для этого нам понадобятся 2 командных оболочки. В первой оболочке мы подключаемся к серверу `cvs` с помощью `ssh` и перенаправляем соединение `cvs`. Во второй оболочке мы используем `cvs`, как если бы он был локальным.

!!! example "shell 1"
    **# ssh -L2401:localhost:2401 colin@cvs_server**   - Прямое подключение к серверу CVS  
    **# ssh -L2401:cvs_server:2401 colin@gateway**     - Или использование шлюза для доступа к CVS  

!!! example "shell 2"
    **# setenv CVSROOT :pserver:colin@localhost:/usr/local/cvs**  
    **# cvs login**  
    *Вход в :pserver:colin@localhost:2401/usr/local/cvs*  
    *Пароль CVS:*  
    **# cvs checkout MyProject/src**

### 12.4 Команды и использование CVS

#### Импорт

Команда `import` используется для добавления целого каталога, она должна выполняться из каталога, который должен быть импортирован. Предположим, что каталог `/devel/` содержит все файлы и подкаталоги для импорта. Имя каталога в CVS (модуль) будет называться "myapp".

!!! example ""
    **# cvs import [options] directory-name vendor-tag release-tag**  
    **# cd /devel**                                                    - Должны быть внутри проекта для его импорта  
    **# cvs import myapp Company R1_0**                                - Метка релиза может быть любым словом  

Спустя некоторое время был добавлен новый каталог "/devel/tools/", который тоже должен быть импортирован.

!!! example ""
    **# cd /devel/tools**  
    **# cvs import myapp/tools Company R1_0**  

#### Обновление, добавление файлов и фиксация изменений

!!! example ""
    **# cvs co myapp/tools**                   - Будет выгружен только каталог tools  
    **# cvs co -r R1_1 myapp**                 - Выгрузить myapp с релизом R1_1 (закрепленным)  
    **# cvs -q -d update -P**                  - Типичное обновление CVS  
    **# cvs update -A**                        - Сбросить любые закрепленные метки (или даты, опция)  
    **# cvs add newfile**                      - Добавить новый файл  
    **# cvs add -kb newfile**                  - Добавить новый бинарный файл  
    **# cvs commit file1 file2**               - Зафиксировать только два файла  
    **# cvs commit -m "Сообщение"**            - Зафиксировать все изменения с сообщением  

#### Создание патча

Лучше всего создавать и применять патч из рабочей директории разработки, связанной с проектом, или из директории исходного кода.

!!! example ""
    **# cd /devel/project**  
    **# diff -Naur olddir newdir > patchfile**     - Создать патч из директории или файла  
    **# diff -Naur oldfile newfile > patchfile**  

#### Применить патч

Иногда необходимо удалить уровень директории из патча, в зависимости от того, как он был создан. В случае затруднений, просто посмотрите первые строки патча и попробуйте `-p0`, `-p1` или `-p2`.

!!! example ""
    **# cd /devel/project**  
    **# patch --dry-run -p0 < patchfile**    - Проверить путь без его применения  
    **# patch -p0 < patchfile**  
    **# patch -p1 < patchfile**              - удалить первый уровень из пути  
