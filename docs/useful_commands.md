## 15 Полезные команды

!!! abstract ""
    [less](#151-less) | [vi](#152-vi) | [mail](#153-mail) | [tar](#154-tar) | [zip](#155-zipunzip) | [dd](#156-dd) | [screen](#157-screen) | [tmux](#158-tmux) | [find](#159-найти) | [Разное](#1510-разное)

### 15.1 less

Команда less отображает текстовый документ на консоли. Она присутствует в большинстве установок.

!!! example ""
    **# less unixtoolbox.xhtml**

Некоторые важные команды (символ ^N обозначает ++ctrl+n++):

!!! note ""
    *h  H* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - Хорошая справка по отображению  
    *f  ^F  ^V  SPACE* &nbsp; &nbsp; &nbsp; - Просмотреть следующее окно (или N строк).  
    *b  ^B  ESC-v* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - Просмотреть предыдущее окно (или N строк).  
    *F* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - Перейти к концу файла; аналог "tail -f".  
    */pattern* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - Поиск строки впереди (N-го) совпадения.  
    *?pattern* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  - Поиск строки назад (N-го) совпадения.  
    *n* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - Повторить предыдущий поиск (для N-го вхождения).  
    *N* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - Повторить предыдущий поиск в обратном направлении.  
    *q* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - Выход  

### 15.2 vi

Vi представлен на ЛЮБОЙ установке Linux/Unix (кроме Gentoo?) и поэтому полезно знать некоторые основные команды. Есть два режима: командный режим и режим вставки. Командный режим доступен с помощью ++escape++, режим вставки с помощью ++i++. Используйте ++colon++ - help, если запутались.

#### Выход

!!! info ""
    **:w <новое Имя Файла>** &nbsp; &nbsp; &nbsp; - сохранить файл с новым именем  
    **:wq** или **:x** &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - сохранить и выйти  
    **:q!** &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - выйти без сохранения  

#### Поиск и перемещение

!!! info ""
    **/\<string>** &nbsp; &nbsp; &nbsp; &nbsp; - Поиск строки впереди  
    **?\<string>** &nbsp; &nbsp; &nbsp; &nbsp; - Поиск строки назад  
    **n** &nbsp; &nbsp; &nbsp; &nbsp; - Поиск следующего вхождения строки  
    **N** &nbsp; &nbsp; &nbsp;&nbsp;  - Поиск предыдущего вхождения строки  
    **{** &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; - Переместиться на предыдущий абзац  
    **}** &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; - Переместиться на следующий абзац  
    **1G** &nbsp; &nbsp; &nbsp; - Переместиться на первую строку файла  
    **nG** &nbsp; &nbsp; &nbsp; - Переместиться на n-ую строку файла  
    **G** &nbsp; &nbsp; &nbsp; &nbsp; - Переместиться на последнюю строку файла  
    **:%s/\<OLD>/\<NEW>/g** &nbsp; &nbsp; &nbsp; - Поиск и замена каждого вхождения  

#### Удаление, копирование и вставка текста

!!! info ""
    **dd** (**dw**) &nbsp; &nbsp; &nbsp; - Вырезать текущую строку (слово)  
    **D** &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - Вырезать до конца строки  
    **x** &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - Удалить (вырезать) символ  
    **yy** (**yw**) &nbsp; &nbsp; &nbsp; - Скопировать строку (слово) после курсора  
    **P** &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - Вставить после курсора  
    **u** &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - Отменить последнее изменение  
    **U** &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - Отменить все изменения в текущей строке  

### 15.3 mail

Команда mail является основным инструментом для чтения и отправки электронной почты, она обычно устанавливается. Для отправки электронного письма просто введите "mail user@domain". Первая строка является заголовком, затем содержимое письма. Завершите и отправьте письмо с помощью одной точки (.) в новой строке. Пример:

!!! example ""
    **# mail c@cb.vu**  
    *Subject: Ваш текст полон опечаток*  
    *"На мгновение ничего не произошло. Затем, через секунду или около того, ничего продолжало происходить."*  
    *.*  
    *EOT*  
    **#**  

Также это работает с использованием канала:

!!! example ""
    **# echo "This is the mail body" | mail c@cb.vu**

Это также простой способ проверить почтовый сервер.

### 15.4 tar

Команда `tar` (архивация на ленту) создает и извлекает архивы файлов и каталогов. Архив .tar несжат, сжатый архив имеет расширение `.tgz` или `.tar.gz` (zip) или `.tbz` (bzip2). Не используйте абсолютный путь при создании архива, вероятно, вы захотите распаковать его в другое место. Некоторые типичные команды:

#### Создание

!!! example ""
    **# cd /**  
    **# tar -cf home.tar home/**        - архивировать весь каталог /home (c для создания)  
    **# tar -czf home.tgz home/**       - то же самое с сжатием zip  
    **# tar -cjf home.tbz home/**       - то же самое с сжатием bzip2  

Включите только один (или два) каталога из дерева, но сохраните относительную структуру. Например, архивируйте `/usr/local/etc` и `/usr/local/www`, а первый каталог в архиве должен быть `local/`.

!!! example ""
    **# tar -C /usr -czf local.tgz local/etc local/www**  
    **# tar -C /usr -xzf local.tgz**    - Разархивировать каталог local в /usr  
    **# cd /usr; tar -xzf local.tgz**   - То же самое, что и выше  

#### Извлечение

!!! example ""
    **# tar -tzf home.tgz**             - просмотреть содержимое архива без извлечения (список)  
    **# tar -xf home.tar**              - распаковать архив здесь (x для извлечения)  
    **# tar -xzf home.tgz**             - то же самое с сжатием zip (-xjf для сжатия bzip2)  
    **# tar --strip-components 1 -zxvf gallery2.tgz -C gallery/**   - удалить начальный путь gallery2 и извлечь в gallery  
    **# tar -xjf home.tbz home/colin/file.txt**                     - Восстановить один файл  
    **# tar -xOf home.tbz home/colin/file.txt**                     - Вывести файл в stdout (без извлечения)  

#### Более продвинутое

!!! example ""
    **# tar c dir/ | gzip | ssh user@remote 'dd of=dir.tgz'**                 - архивировать `dir/` и сохранить удаленно  
    **# tar cvf - \`find . -print\` &gt; backup.tar**                         - архивировать текущий каталог  
    **# tar -cf - -C /etc . | tar xpf - -C /backup/etc**                      - Копировать каталоги  
    **# tar -cf - -C /etc . | ssh user@remote tar xpf - -C /backup/etc**      - Копировать удаленно  
    **# tar -czf home.tgz --exclude '*.o' --exclude 'tmp/' home/**  

Запаковать домашнюю папку в файл `home.tgz`, исключая файлы с расширением `.o` и папку `tmp`.

### 15.5 zip/unzip

Файлы в формате zip могут быть проще обмениваться с Windows.

!!! example ""
    **# zip -r fileName.zip /path/to/dir**                    - архивировать папку dir в файл `fileName.zip`  
    **# unzip fileName.zip**                                  - разархивировать zip-файл  
    **# unzip -l fileName.zip**                               - показать содержимое архива  
    **# unzip -c fileName.zip fileinside.txt**                - вывести содержимое одного файла на экран (без извлечения)  
    **# unzip fileName.zip fileinside.txt**                   - извлечь только один файл  

### 15.6 dd

Программа `dd` (disk dump или destroy disk или смотреть значение dd) используется для копирования разделов и дисков и для других операций копирования. Обычное использование:

!!! example ""
    **# dd if=\<source> of=\<target> bs=\<byte size=""> conv=\<conversion>**  
    **# kill -INFO PID**                                        - Показать прогресс dd (FreeBSD, OSX)  

Важные опции conv:

!!! example ""
    *notrunc* &nbsp; &nbsp; &nbsp; не обрезать выходной файл, все нули будут записаны как нули  
    *noerror* &nbsp; &nbsp; &nbsp; продолжать после ошибок чтения (например, битых блоков)  
    *sync* &nbsp; &nbsp; &nbsp; добавить входной блок нулями до размера `ibs-size`  

Размер блока по умолчанию - 512 (один блок). MBR, где находится таблица разделов, находится на первом блоке, первые 63 блока диска пустые. Большие размеры блоков копируются быстрее, но требуют больше памяти.

#### Резервное копирование и восстановление

!!! example ""
    **# dd if=/dev/hda of=/dev/hdc bs=16065b**                               - Копирование диска на диск (одинакового размера)  
    **# dd if=/dev/sda7 of=/home/root.img bs=4096 conv=notrunc,noerror**     - Резервное копирование /  
    **# dd if=/home/root.img of=/dev/sda7 bs=4096 conv=notrunc,noerror**     - Восстановление /  
    **# dd bs=1M if=/dev/ad4s3e | gzip -c &gt; ad4s3e.gz**                   - Архивирование резервной копии  
    **# gunzip -dc ad4s3e.gz | dd of=/dev/ad0s3e bs=1M**                     - Восстановление из архива  
    **# dd bs=1M if=/dev/ad4s3e | gzip | ssh eedcoba@fry 'dd of=ad4s3e.gz'** - также удаленно  
    **# gunzip -dc ad4s3e.gz | ssh eedcoba@host 'dd of=/dev/ad0s3e bs=1M'**  
    **# dd if=/dev/ad0 of=/dev/ad2 skip=1 seek=1 bs=4k conv=noerror**        - Пропустить MBR  
        *Это необходимо, если место назначения (ad2) меньше*  
    **# dd if=/vm/FreeBSD-8.2-RELEASE-amd64-memstick.img of=/dev/disk1 bs=10240 conv=sync**  
        *Копирование образа FreeBSD на флешку*  

#### Восстановление

Команда `dd` прочитает каждый отдельный блок раздела. В случае проблем рекомендуется использовать опцию conv=sync,noerror, таким образом `dd` пропустит битый блок и запишет нули по назначению. Важно установить размер блока равным или меньшему, чем размер блока исходного раздела размер блока диска. Размер `1K` кажется безопасным, установите его с помощью `bs=1к`. Если на диске есть битые секторы и данные должны быть восстановлены с раздела, создайте файл образа с помощью `dd`, смонтируйте образ и скопируйте содержимое на новый диск. Со включенной опцией noerror dd будет пропускать битые секторы и писать на их месте нули, таким образом будет потеряны только данные, содержащиеся в битых секторах.

!!! example ""
    **# dd if=/dev/hda of=/dev/null bs=1м**                               - Проверка на наличие битых блоков  
    **# dd bs=1к if=/dev/hda1 conv=sync,noerror,notrunc | gzip | ssh \\** - Отправка на удаленный сервер  
    **root@fry 'dd of=hda1.gz bs=1k'**  
    **# dd bs=1к if=/dev/hda1 conv=sync,noerror,notrunc of=hda1.img**     - Сохранение в образ  
    **# mount -o loop /hda1.img /mnt**                                    - Монтирование образа  
    **# rsync -ax /mnt/ /newdisk/**                                       - Копирование на новый диск  
    **# dd if=/dev/hda of=/dev/hda**                                      - Обновление магнитного состояния  
      *Вышеуказанное полезно для обновления диска. Это абсолютно безопасно, но должно быть размонтировано.*  

#### Удаление

!!! example ""
    **# dd if=/dev/zero of=/dev/hdc**                         - Полное удаление диска  
    **# dd if=/dev/urandom of=/dev/hdc**                      - Полное удаление диска смешанной информацией  
    **# kill -USR1 PID**                                      - Просмотр прогресса dd (Linux)  
    **# kill -INFO PID**                                      - Просмотр прогресса dd (FreeBSD)  

#### Манипуляции с MBR

MBR содержит загрузчик и таблицу разделов и имеет размер 512 байт. Первые 446 байт предназначены для загрузчика, байты с 446 по 512 предназначены для таблицы разделов.

!!! example ""
    **# dd if=/dev/sda of=/mbr_sda.bak bs=512 count=1**                  - Резервное копирование полного MBR  
    **# dd if=/dev/zero of=/dev/sda bs=512 count=1**                     - Удаление MBR и таблицы разделов  
    **# dd if=/mbr_sda.bak of=/dev/sda bs=512 count=1**                  - Восстановление полного MBR  
    **# dd if=/mbr_sda.bak of=/dev/sda bs=446 count=1**                  - Восстановление только загрузчика  
    **# dd if=/mbr_sda.bak of=/dev/sda bs=1 count=64 skip=446 seek=446** - Восстановление таблицы разделов  

### 15.7 screen

Screen (необходимый инструмент) имеет две основные функции:

* Запуск нескольких терминальных сеансов внутри одного терминала.
* Запущенная программа отделена от реального терминала и может работать в фоновом режиме. Реальный терминал может быть закрыт и вновь подключен позже.

#### Пример быстрого запуска

запустите screen с помощью:

!!! example ""
    **# screen**

Внутри сеанса screen мы можем запустить долгосрочную программу (например, top).

!!! example ""
    **# top**

Теперь отсоедините с помощью ++ctrl+a++ ++ctrl+d++. Подключите терминал снова с помощью:

!!! example ""
    **# screen -R -D**

Подробнее это означает следующее: если сеанс работает, то подключиться заново. Если необходимо удалить соединение удаленно и сначала выйти из него. Если оно не запущено, создать и уведомить пользователя. Или:

!!! example ""
    **# screen -x**

Присоединиться к работающему экрану в режиме многократного отображения. Таким образом, консоль используется несколькими пользователями. Очень полезно для совместной работы/отладки!

Команды для экрана (внутри экрана)
Все команды для экрана начинаются с ++ctrl+a++.

!!! example ""
    ++ctrl+a++ ++question++                       - справка и краткое описание функций  
    ++ctrl+a++ ++c++                              - создать новое окно (терминал)  
    ++ctrl+a++ ++ctrl+n++ и ++ctrl+a++ ++ctrl+p++ - переключиться на следующее или предыдущее окно в списке по номеру  
    ++ctrl+a++ ++ctrl++ + `N`                     - где N - число от 0 до 9, - переключиться на соответствующее окно  
    ++ctrl+a++ ++double-quote++                   - получить список запущенных окон  
    ++ctrl+a++ ++a++                              - очистить пропущенное ++ctrl+a++  
    ++ctrl+a++ ++ctrl+d++                         - отключиться и оставить сеанс работающим в фоновом режиме  
    ++ctrl+a++ ++x++                              - заблокировать терминал экрана с помощью пароля  
    ++ctrl+a++ ++bracket-left++                   - войти в режим прокрутки, выйти с помощью ++esc++  

!!! example ""
     Используйте `echo "defscrollback 5000" > ~/.screenrc`, чтобы увеличить буфер (по умолчанию 100)  
    ++c+u++      - прокрутка окна на полстраницы вверх  
    ++c+b++      - прокрутка окна на полную страницу вверх  
    ++c+d++      - прокрутка окна на полстраницы вниз  
    ++c+f++      - прокрутка окна на полную страницу вниз  
    ++slash++    - поиск вперед  
    ++question++ - поиск назад  

Сеанс экрана завершается, когда программа в работающем терминале закрывается и вы выходите из терминала.

### 15.8 Tmux

Tmux (ти-макс) — это менеджер терминалов, который позволяет работать с несколькими сессиями в одном окне. То есть вместо нескольких открытых окон терминала — вы используете одно, которое можно делить на несколько окон.

#### Работа с сессиями

!!! example ""
    **#tmux new -s <название сессии>**          - Для создания именной сессии;  
    **#tmux attach || tmux new**                - Возобновить работу;  
    **#tmux ls**                                - Просмотреть список созданных сессий;  
    **#tmux attach -t <наименование сессии>**   - Восстановить подключение;  
    ++ctrl+b++, ++s++                           - Переключение между сессиями находясь в другой сессии;  
    ++ctrl+b++, ++d++                           - Выйти из сессии;  
    **#tmux kill-session -t <название сессии>** - Завершить сессию;  
    **#tmux kill-server**                       - Закрыть все сессии.  

#### Создание окон и переключение между ними

!!! example ""
    ++ctrl+b++, ++c++               — создать новое окно;  
    ++ctrl+b++, ++w++               — просмотреть список окон;  
    ++ctrl+b++, ++n++               — следующее окно;  
    ++ctrl+b++, ++p++               — предыдущее окно;  
    ++ctrl+b++, ++w++               — следующее окно;  
    ++ctrl+b++, номер окна (цифрой) — переключиться на нужное окно;  
    ++ctrl+b++, ++double-quote++    — горизонтальное разделение окна;  
    ++ctrl+b++, ++"&percnt;"++      — вертикальное разделение окна.  

### 15.9 Найти

Некоторые важные опции:

!!! example ""
    `-x` (на BSD) `-xdev` (на Linux)         - остаться в той же файловой системе (dev в fstab)  
    `-exec cmd {} \;`                        - выполнить команду и заменить {} полным путем  
    `-exec grep -H 'искомый текст' {} \;`    - поиск текста внутри файлов  
    `-iname`                                 - как `-name`, но без учета регистра  
    `-ls`                                    - отображать информацию о файле (подобно ls -la)  
    `-size n`                                - размер n (k M G T P)  
    `-cmin n`                                - статус файла был изменен n минут назад  

!!! example ""
    **# find . -type f ! -perm -444**                                                            - Найти файлы, которые не доступны для чтения всем  
    **# find . -type d ! -perm -111**                                                            - Найти каталоги, к которым нет доступа у всех  
    **# find /home/user/ -cmin 10 -print**                                                       - Файлы, созданные или измененные в последние 10 минут  
    **# find . -name '*.[ch]' | xargs grep -E 'expr'**                                           - Поиск 'expr' в данном каталоге и ниже  
    **# find / -name "*.core" | xargs rm**                                                       - Найти дампы ядра и удалить их (попробуйте также core.\*)  
    **# find / -name "*.core" -print -exec rm {} \;**                                            - Другой синтаксис  
        *Найти изображения и создать архив, iname не учитывает регистр. `-r` для добавления*  
    **# find . \( -iname "*.png" -o -iname "*.jpg" \) -print -exec tar -rf images.tar {} \;**  
    **# find . -type f -name "*.txt" ! -name README.txt -print**                                 - Исключить файлы README.txt  
    **# find /var/ -size +10M -exec ls -lh {} \;**                                               - Найти большие файлы > 10 МБ  
    **# find /var/ -size +10M -ls**                                                              - Проще  
    **# find . -size +10M -size -50M -print**  
    **# find /usr/ports/ -name work -type d -print -exec rm -rf {} \;**                          - Очистить порты  
        *Найти файлы с установленным SUID; эти файлы уязвимы и должны быть защищены*  
    **# find / -type f -user root -perm -4000 -exec ls -l {} \;**  

Будьте осторожны с xargs или exec, так как они могут или не могут соблюдать кавычки и могут давать неверные результаты, когда файлы или каталоги содержат пробелы. В случае сомнений используйте `-print0 | xargs -0` вместо `| xargs`. Опция `-print0` должна быть последней в команде find. См. этот небольшой учебник по [find](http://www.hccfl.edu/pollock/Unix/FindCmd.htm).

!!! example ""
    **# find . -type f | xargs ls -l**              - Не будет работать с пробелами в названиях  
    **# find . -type f -print0 | xargs -0 ls -l**   - Будет работать с пробелами в названиях  
    **# find . -type f -exec ls -l '{}' \;**        - Или использовать кавычки `{}` с `-exec`  

Дублирование дерева каталогов:

!!! example ""
    **# find . -type d -exec mkdir -p /tmp/new_dest/{} \;**

### 15.10 Разное

!!! example ""
    **# which command**                      - Показать полный путь к команде  
    **# time command**                       - Узнать, сколько времени занимает выполнение команды  
    **# time cat**                           - Использовать time как секундомер. ++ctrl+c++ для остановки  
    **# set | grep $USER**                   - Список текущего окружения  
    **# cal -3**                             - Вывести трёхмесячный календарь  
    **# date [-u|--utc|--universal] [MMDDhhmm[[CC]YY][.ss]]**  
    **# date 10022155**                      - Установить дату и время  
    **# whatis grep**                        - Вывести краткую информацию о команде или слове  
    **# whereis java**                       - Поиск в пути и стандартных каталогах для слова  
    **# setenv varname value**               - Установить значение переменной среды varname в value (csh/tcsh)  
    **# export varname="value"**             - Установить значение переменной среды varname в value (sh/ksh/bash)  
    **# pwd**                                - Вывести текущий рабочий каталог  
    **# mkdir -p /path/to/dir**              - Создать каталог (не выдавать ошибку, если он уже существует) и создавать необходимые родительские каталоги  
    **# mkdir -p project/{bin,src,obj,doc/{html,man,pdf},debug/some/more/dirs}**  
    **# rmdir /path/to/dir**                 - Удалить каталог  
    **# rm -rf /path/to/dir**                - Удалить каталог и его содержимое (принудительно)  
    **# rm -- -badchar.txt**                 - Удаляем файл, начинающийся с дефиса (-)  
    **# cp -la /dir1 /dir2**                 - Архивируем и создаем жесткую ссылку вместо копирования  
    **# cp -lpR /dir1 /dir2**                - То же самое для FreeBSD  
    **# cp unixtoolbox.xhtml{,.bak}**        - Копируем файл с новым расширением  
    **# mv /dir1 /dir2**                     - Переименовываем директорию  
    **# ls -1**                              - Выводим список файлов по одному в строке  
    **# history | tail -50**                 - Отображаем 50 последних использованных команд  
    **# cd -**                               - Переходим в предыдущую ($OLDPWD) директорию  
    **# /bin/ls| grep -v .py | xargs rm -r** - Передаем имена файлов через канал в команду `rm` с помощью `xargs`  

Проверка контрольных сумм файлов с помощью openssl. Похожая альтернатива командам md5sum или sha1sum (FreeBSD использует md5 и sha1), которые не всегда установлены.

!!! example ""
    **# openssl md5 file.tar.gz**            - Генерируем контрольную сумму MD5 из файла  
    **# openssl sha1 file.tar.gz**           - Генерируем контрольную сумму SHA1 из файла  
    **# openssl rmd160 file.tar.gz**         - Генерируем контрольную сумму RIPEMD-160 из файла  
