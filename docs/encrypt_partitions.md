## 10 Шифрование разделов

!!! abstract ""
    [Linux с LUKS](#101-linux) | [FreeBSD GELI](#102-freebsd) | [Образ OS X](#103-зашифрованный-дисковый-образ-os-x)

Существует (много) других альтернативных методов шифрования дисков, я показываю здесь только методы, которые я знаю и использую. Имейте в виду, что безопасность хороша только до тех пор, пока с операционной системой не произошло ничего предосудительного. Злоумышленник может легко записать пароль из событий клавиатуры. Кроме того, данные свободно доступны, когда раздел подключен, и это не помешает злоумышленнику получить к ним доступ в этом состоянии.

### 10.1 Linux

Средство Linux dm-crypt (device-mapper), доступное в ядре 2.6. В этом примере давайте зашифруем раздел `/dev/sdc1`, хотя это может быть любой другой раздел или диск, или USB, или раздел на основе файла, созданный с `losetup`. В этом случае мы использовали бы `/dev/loop0`. См. файловый раздел образа. Диспетчер устройств использует метки для идентификации раздела. Мы используем `sdc1` в этом примере, но это может быть любая строка.

#### dm-crypt с LUKS

LUKS с dm-crypt имеет лучшее шифрование и позволяет иметь несколько фраз-паролей для одного и того же раздела или легко изменить пароль. Чтобы проверить, доступен ли LUKS, просто введите `# cryptsetup --help`, если ничего о LUKS не появляется, используйте инструкции ниже [Без LUKS](#dm-crypt-без-luks). Сначала создайте раздел, если необходимо: `fdisk /dev/sdc`.

!!! example "Создание зашифрованного раздела"
    **# dd if=/dev/urandom of=/dev/sdc1**             - Необязательно. Только для параноиков (занимает дни)  
    **# cryptsetup -y luksFormat /dev/sdc1**          - Это уничтожает все данные на sdc1  
    **# cryptsetup luksOpen /dev/sdc1 sdc1**  
    **# mkfs.ext3 /dev/mapper/sdc1**                  - создать файловую систему ext3  
    **# mount -t ext3 /dev/mapper/sdc1 /mnt**  
    **# umount /mnt**  
    **# cryptsetup luksClose sdc1**                   - Отключить зашифрованный раздел  

!!! example "Прикрепить"
    **# cryptsetup luksOpen /dev/sdc1 sdc1**  
    **# mount -t ext3 /dev/mapper/sdc1 /mnt**  

!!! example "Открепить"
    **# umount /mnt**  
    **# cryptsetup luksClose sdc1**  

#### dm-crypt без LUKS

!!! example ""
    **# cryptsetup -y create sdc1 /dev/sdc1** - или любой другой раздел, например `/dev/loop0`  
    **# dmsetup ls**                          - проверить, отобразит: sdc1 (254, 0)  
    **# mkfs.ext3 /dev/mapper/sdc1**          - Это делается только при первом использовании!  
    **# mount -t ext3 /dev/mapper/sdc1 /mnt**  
    **# umount /mnt**  
    **# cryptsetup remove sdc1**              - Отключить зашифрованный раздел  

Сделайте точно так же (без части mkfs!), чтобы повторно подключить раздел.

Если пароль неверен, команда mount завершится неудачей. В этом случае просто удалите карту `sdc1` (`cryptsetup remove sdc1`) и создайте ее заново.

### 10.2 FreeBSD

Два популярных модуля шифрования дисков FreeBSD - это `gbde` и `geli`. Теперь я использую `geli`, потому что он быстрее и также использует криптоустройство для аппаратного ускорения. См. [Руководство FreeBSD, Глава 18.6](http://www.freebsd.org/handbook/disks-encrypting.html) для получения всех подробностей. Модуль `geli` должен быть загружен или скомпилирован в ядро:

!!! example ""
    **options GEOM_ELI**  
    **device crypto**                                     - или как модуль:  
    **# echo 'geom_eli_load="YES"' >> /boot/loader.conf** - или выполните: `kldload geom_eli`  

#### Использовать пароль и ключ

Используя эти настройки для типичного шифрования диска, оно использует фразу-пароль. И ключ для шифрования мастер-ключа. То есть вам нужны и пароль, и сгенерированный ключ `/root/ad1.key`, чтобы подключить раздел. Мастер-ключ хранится внутри раздела и не виден. См. ниже типичный пример для USB или файлового образа.

!!! example "Создать зашифрованный раздел"
    **# dd if=/dev/random of=/root/ad1.key bs=64 count=1** - этот ключ шифрует мастер-ключ  
    **# geli init -s 4096 -K /root/ad1.key /dev/ad1**      - `-s 8192` также хорошо для дисков  
    **# geli attach -k /root/ad1.key /dev/ad1**            - ОБЯЗАТЕЛЬНО сделайте резервную копию `/root/ad1.key`  
    **# dd if=/dev/random of=/dev/ad1.eli bs=1m**          - Необязательно и занимает много времени  
    **# newfs /dev/ad1.eli**                               - Создать файловую систему  
    **# mount /dev/ad1.eli /mnt**  

!!! example "Подключить"
    **# geli attach -k /root/ad1.key /dev/ad1**  
    **# fsck -ny -t ffs /dev/ad1.eli**  - При сомнениях проверьте файловую систему  
    **# mount /dev/ad1.eli /mnt**  

Процедура отключения выполняется автоматически при выключении.

!!! example "Отключить"
    **# umount /mnt**  
    **# geli detach /dev/ad1.eli**  

Зашифрованный раздел может быть настроен для монтирования с помощью `/etc/fstab`.
Пароль будет запрошен при загрузке. Для этого примера требуются следующие настройки:

!!! info "/etc/fstab"
    **# grep geli /etc/rc.conf**  
    *geli_devices="ad1"*  
    *geli_ad1_flags="-k /root/ad1.key"*  
    **# grep geli /etc/fstab**  
    */dev/ad1.eli /home/private ufs rw 0 0*  

#### Использовать только пароль

Удобнее зашифровать флешку USB или файловый образ только с фразой-паролем, без ключа. В этом случае не нужно носить с собой дополнительный ключевой файл. Процедура очень похожа на приведенную выше, просто без ключевого файла. Давайте зашифруем файловый образ `/cryptedfile` размером 1 ГБ.

!!! example ""
    **# dd if=/dev/zero of=/cryptedfile bs=1M count=1000** - файл 1 ГБ  
    **# mdconfig -at vnode -f /cryptedfile**  
    **# geli init /dev/md0**                               - шифрует только паролем  
    **# geli attach /dev/md0**  
    **# newfs -U -m 0 /dev/md0.eli**  
    **# mount /dev/md0.eli /mnt**  
    **# umount /dev/md0.eli**  
    **# geli detach md0.eli**  

Теперь этот образ можно монтировать на другой системе, используя только пароль.

!!! example ""
    **# mdconfig -at vnode -f /cryptedfile**  
    **# geli attach /dev/md0**  
    **# mount /dev/md0.eli /mnt**  

### 10.3 Зашифрованный дисковый образ OS X

Не знаю только командной строкой. См. [Зашифрованный дисковый образ OS X](https://wiki.thayer.dartmouth.edu/display/computing/Creating+a+Mac+OS+X+Encrypted+Disk+Image)
и [поддержка Apple](http://support.apple.com/kb/ht1578)
